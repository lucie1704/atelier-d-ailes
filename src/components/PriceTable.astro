---
import type { PriceItem } from '~/types';
import Tag from './ui/Tag.astro';

interface Props {
  id?: string;
  title: string;
  subtitle?: string;
  items?: PriceItem[];
}

const { id, title, subtitle, items = [] } = Astro.props;

interface RowData {
  item: PriceItem;
  level: number;
}

const flattenItems = (items: PriceItem[], level: number = 0): RowData[] => {
  const result: RowData[] = [];

  for (const item of items) {
    result.push({ item, level });

    if (item.children) {
      result.push(...flattenItems(item.children, level + 1));
    }
  }

  return result;
};

const getPaddingClass = (level: number): string => {
  if (level === 0) return 'pl-4';
  if (level === 1) return 'pl-12';
  return 'pl-20';
};

const allRows = flattenItems(items);
---

<section {...id && { id }} class="max-w-4xl mx-auto my-16 px-4 scroll-mt-24">
  <h2 class="text-3xl md:text-4xl font-bold tracking-tighter mb-6 font-heading text-center">
    {title}
  </h2>

  {subtitle && <p class="mb-6 text-muted text-xl text-center mx-10" set:html={subtitle} />}

  <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th></th>
          <th class="text-left px-4 py-3 font-semibold text-gray-700"> Prix </th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        {
          allRows.map(({ item, level }) => {
            const paddingClass = getPaddingClass(level);
            const fontClass = level === 0 && item.children ? 'font-semibold' : '';

            return (
              <tr class="hover:bg-gray-50 transition-colors">
                <td class={`py-3 ${paddingClass} ${fontClass}`}>{item.title}</td>

                <td class="px-4 py-3">
                  {item.price && (item.price === 'quote' ? <Tag>Sur devis</Tag> : `${item.price}\u00A0â‚¬`)}
                </td>
              </tr>
            );
          })
        }
      </tbody>
    </table>
  </div>
</section>
